# strong-db-watcher

Event broadcast/watch mechanism triggered by internal database events
such as Create, Update or Delete.


## Broadcast: Class method

- `dbClient` a postgres handle already connected to the DB
- `tableNames` array of {String}
- `callback` {Function} called with err.  err being null means Broadcast setup completed.

Broadcast registers triggers and associates the triggers with tables.
In distributed environment, all the users of strong-db-watcher need to agree on
the triggers and the tables.  When backward incompatible changes are made to triggers
or tables to be watched, all broadcasters and watchers need to be updated.


## Usage: Broadcast

```
    var pg = require('pg');
    var DbWatcher = require('strong-db-watcher');
    var tableName = 'serviceinstance';

    var client = new pg.Client(<connection string>);
    client.connect(function(err) {

      DbWatcher.Broadcast(client, [tableName], function(err) {
        if (err) console.log('Broadcast error');
    });
```


## DbWatcher: Class, inherits EventEmitter

- `dbClient` a postgres handle already connected to the DB
- `changeListener` {Function} called at every watched event with (result) where,
    - result: {Object}
      - `table` {String} table name,
      - `op` {String} `INSERT`, `UPDATE`, `INSERTorUPDATE`, or `DELETE`
      - `when` {String} `BEFORE`, `AFTER`, or `UNSPECIFIED`
      - `payload`{Object} database record
      - `receivedAt` {Integer} timestamp in msec since the epoch
         when the broadcast msg is received by the watcher,
         not when the broadcast event is generated by the broadcaster.

    Event is emitted per each table with result {Object}.
    In case changeListener is set, it's called for every event
    in addition to event.  Usage below shows how to watch events.

### watchTable

- `name` {String} table name,
- `callback` {Function} called with err

### unwatchTable

unwatch one table

- `name` {String} table name,
- `callback` {Function} called with err

### close

unwatch all the watching tables

- `callback` {Function} called with err

## Usage: notified by changeListener

```
    var pg = require('pg');
    var DbWatcher = require('strong-db-watcher');
    var tableName = 'serviceinstance';

    var client = new pg.Client(<connection string>);
    client.connect(function(err) {
      var sdw = new DbWatcher(client,
        function(err, result) {
          ... all events are watched ...
          ... switch (result.table) case to ...
          ... process all events here or emit your own event ...
        });
    sdw.watchTable(name);
```

## Usage: notified by Events

```
    var pg = require('pg');
    var DbWatcher = require('strong-db-watcher');
    var tableName = 'serviceinstance';

    var client = new pg.Client(<connection string>);
    client.connect(function(err) {
      var sdw = new DbWatcher(client);
      sdw.on(name,
        function(err, result) {
          ... process the result here ...
          ... events for the table only ...
        });
    sdw.watchTable(name);
```

## Result:

```
	{
	  table: 'serviceinstance',
	  op: 'UPDATE',
	  when: 'BEFORE',
	  payload:
	    {
	      executorid: 155,
	      serverserviceid: 1,
	      groupid: 1,
	      currentdeploymentid: 'some commit',
	      containerversioninfo: {},
	      token: 'bc1357e132318ade13dd008a882d2d0fe5fb1980e7d98c0a',
	      started: false,
	      setsize: 0,
	      cpus: 'CPU',
	      tracingenabled: false,
	      id: 153
	    },
	  receivedAt: 1440828036502
	}
```
