# strong-db-watcher

Event broadcast/watch mechanism triggered by internal database events
such as Create, Update or Delete.


## Broadcaster: Class method

- `dbClientGetter` {Function} returns a handle already connected to the DB
- `tableNames` array of {String}  If null, use the list in default-tables.json
- `megaWatcher` {Function} called with err and result


## Watcher: Class, inherits EventEmitter

- `dbClientGetter` {Function} returns a handle already connected to the DB
- `megaWatcher` {Function} called at every watched event with (result) where,
    - result: {Object}
      - `table` {String} table name,
      - `op` {String} `INSERT`, `UPDATE`, `INSERTorUPDATE`, or `DELETE`
      - `when` {String} `BEFORE`, `AFTER`, or `UNSPECIFIED`
      - `payload`{Object} database record
      - `receivedAt` {Integer} timestamp in msec since the epoch
         when the broadcast msg is received by the watcher,
         not when the broadcast event is generated by the broadcaster.

    Event is emitted per each table with result {Object}.
    In case megaWatcher is set, megaWatcher is called for every event
    in addition to event.  Usage below shows how to watch events.

### watchTable

- `name` {String} table name,
- `callback` {Function} called with err

### unwatchTable

unwatch one table

- `name` {String} table name,
- `callback` {Function} called with err

### updateClient

let the watcher know when the DB client handle is updated.

### close

unwatch all the watching tables

- `callback` {Function} called with err

## Usage: notified by megaWatcher function

```
     var pg = require('pg');
     var SDW = require('strong-db-watcher');
     var tableName = 'serviceinstance';

     var client = new pg.Client(<connection string>);
     client.connect(function(err){
       var sdw = new SDW(client,
         function(err, result){
            ... all events are watched ...
            ... switch (result.table) case to ...
            ... process all events here or emit your own event ...
         });
       sdw.watchTable(name);
```

## Usage: notified by Events

```
     var pg = require('pg');
     var SDW = require('strong-db-watcher');
     var tableName = 'serviceinstance';

     var client = new pg.Client(<connection string>);
     client.connect(function(err){
       var sdw = new SDW(client);
       sdw.on(name,
         function(err, result){
            ... process the result here ...
            ... events for the table only ...
         });
       sdw.watchTable(name);
```

## Result:

```
	{
	  table: 'serviceinstance',
	  op: 'UPDATE',
	  when: 'BEFORE',
	  payload:
	    {
	      executorid: 155,
	      serverserviceid: 1,
	      groupid: 1,
	      currentdeploymentid: 'some commit',
	      containerversioninfo: {},
	      token: 'bc1357e132318ade13dd008a882d2d0fe5fb1980e7d98c0a',
	      started: false,
	      setsize: 0,
	      cpus: 'CPU',
	      tracingenabled: false,
	      id: 153
	    },
	  receivedAt: 1440828036502
	}
```
